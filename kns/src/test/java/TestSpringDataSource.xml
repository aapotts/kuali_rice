<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <bean id="ojbConfigurer" class="org.springmodules.orm.ojb.support.LocalOjbConfigurer"/>  

  <bean id="jotm" class="org.springframework.transaction.jta.JotmFactoryBean" depends-on="ojbConfigurer">
    <!-- this is a bean factory, we can't set properties on the product from Spring, so the equivelent should
         be done in CoreLifeCycle after Spring has initialized -->
    <!--
    <property name="defaultTimeout"><value>${transaction.timeout}</value></property>
    -->
  </bean>
  
  <bean id="userTransaction" class="edu.iu.uis.eden.database.UserTransactionFactoryBean">
  	<property name="defaultUserTransaction"><ref local="jotm"/></property>
  </bean>
  <bean id="jtaTransactionManager" class="edu.iu.uis.eden.database.TransactionManagerFactoryBean">
  	<property name="defaultTransactionManager"><ref local="jotm"/></property>
  </bean>

  <bean id="transactionManager" class="edu.iu.uis.eden.database.WorkflowJtaTransactionManager" depends-on="jotm">
    <property name="userTransaction"><ref local="userTransaction"/></property>
    <property name="transactionManager"><ref local="jtaTransactionManager"/></property>
  </bean>

  <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
	<property name="transactionManager"><ref bean="transactionManager" /></property>
  </bean>

  <bean id="enWorkflowDataSource" class="edu.iu.uis.eden.database.WorkflowManagedDataSource">
    <property name="transactionManager"><ref local="jtaTransactionManager"/></property>
    <property name="driverClassName"><value>${datasource.driver.name}</value></property>
    <property name="url"><value>${datasource.url}</value></property>
    <property name="maxSize"><value>${datasource.pool.maxSize}</value></property>
    <property name="minSize"><value>${datasource.pool.minSize}</value></property>
    <property name="maxWait"><value>${datasource.pool.maxWait}</value></property>
    <property name="validationQuery"><value>${datasource.pool.validationQuery}</value></property>   
    <property name="username"><value>${datasource.username}</value></property>
    <property name="password"><value>${datasource.password}</value></property>
  </bean>
  
  <bean id="matchAllWithPropReq" class="org.springframework.transaction.interceptor.MatchAlwaysTransactionAttributeSource">
	<property name="transactionAttribute">
		<value>PROPAGATION_REQUIRED</value>
	</property>
  </bean>

  <bean id="matchAllTxInterceptor" class="org.springframework.transaction.interceptor.TransactionInterceptor">
	<property name="transactionManager">
		<ref bean="transactionManager" />
	</property>
	<property name="transactionAttributeSource">
		<ref bean="matchAllWithPropReq" />
	</property>
  </bean>
  
</beans>
